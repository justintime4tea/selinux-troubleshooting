# SELinux Troubleshooting

## Investigating SELinux issues

You can troubleshoot SELinux issues by using `setroubleshoot`. You can resolve the issues using `ausearch`, `audit2allow`, `checkmodule`, `semodule_package`, and `semodule`. 

Additionally, if you'd like to start contributing to or maintaining SELinux packages, instructions on how to use `make` and RHEL/Fedora package utilities are included in this document.

### Install pre-requisite packages

To troubleshoot and fix SELinux issues on a RHEL family OS (CentOS, RHEL, Fedora, etc...) install the following.

```shell
sudo dnf install setroubleshoot 
```

## Adding SELinux policies (manualy)

You can create and install an SELinux policy fairly easily without `sepolicy generate`, RHEL/Fedora package tooling or `make`. If you need to quickly add a minor modification to SELinux policies, this may be the way to go!

First, use the helper script `create-te.sh` to create an SELinux type enforcement (TE) file. All you need to do is supply it the name of the process that is being denied by SELinux. 

Second, inspect the TE file created by the helper script and make any desired modifications, if warranted, and check for security concerns.

Third, use the helper script `install-policy.sh` to generate and install the new SELinux policy package using the previoulsy created TE file.

### Example

Let's pretend that `dnsmasq` is being denied write access to `/etc/resolv.conf` among other issues.

```shell
# Be sure to check the resulting TE file - dnsmasq-selinux.te
create-te.sh dnsmasq

# Make any desired changes to the TE file BEFORE running install-policy.sh. 
install-policy.sh dnsmasq
```

You've succesfully added a new SELinux policy! C'est magnifique!

## Adding SELinux policies using make or RPM

If you want to maintain or contribute to SELinux policy packages, you may want to do so using tools like `make` and have a more "proper" SELinux policy development environment.

### Install pre-requisite packages

We will use `sepolicy generate` to create all the necessary files and `make` to build/install SELinux policies. Install the following.

_If you're planning on using the first method, using just the helper scripts or manually, you can skip these dependencies._

```shell
sudo dnf install make selinux-policy-devel
```

For the sake of this example, we will pretend we have a program/service named `rulebreaker`. In our example `rulebreaker` is an executable file that is located at `/usr/bin/rulebreaker`.

### Create scaffolding
First, you'll need to create a directory to work in and initilize the `sepolicy` managed policy.

```shell
mkdir rulebreaker-selinux-1.0.0
cd rulebreaker-selinux-1.0.0

sepolicy generate --init /usr/bin/rulebreaker

tree
#.
# ├── rulebreaker.fc
# ├── rulebreaker.if
# ├── rulebreaker_selinux.spec
# ├── rulebreaker.sh
# └── rulebreaker.te
```

### Generate type enforcement files
You can use `SETroubleshoot` to detect SELinux issues and determine what new rules are needed however, in this section we will use `ausearch` and `audit2allow` directly. We need to search for where rulebreaker has been denied permission and generate a type enforcement file.

You'll notice that `sepolicy generate` created a type enforcement file for us, among other files so we need to create our own temporary type enforcement file, using a different name, to contain the rules generated by `audit2allow`.

_If you're not using SETroubleshoot, you can use the helper script, `create-te.sh`, instead of running `ausearch` and `audit2allow` directly. It will create TE files with the suffix '-selinux`. **You will still need to manually merge TE files**._

```shell
sudo ausearch -c rulebreaker --raw | sudo audit2allow -a -m rulebreaker -o rulebreaker-selinux.te
```

**Merge (by hand) the contents of `rulebreaker-selinux.te` into `rulebreaker.te`.**

### Building and installing with make

To install the SELinux policy using _only_ make, run the following commands.

```shell
make
sudo make install-policy
sudo semodule -l | grep rulebreaker
```

After running `rulebreaker`, repeat the "generating type enforcement files" and "Building and installing with make" sections to catch any additional rules that may need to be added.

### Building and installing using RPM

To install the SELinux policy using RPM, run the following commands.

```shell
sudo ./rulebreaker.sh
sudo dnf install rulebreaker_selinux-1.0-1.fc40app.src.rpm
```

If you'd like to "automate" searching the audit log and modifying TE files, you can append `--update` to the script generated by `sepolicy`. Given our example application, `rulebreaker`, it would look like the following:

```shell
sudo ./rulebreaker.sh --update
sudo dnf install --reinstall rulebreaker_selinux-1.0-1.fc40app.src.rpm
```

Finally, one last helpful tidbit, you can run the following succinct set of commands to quickly spin-up (and update) a new SELinux policy directory and install the associated policy package:

```shell
mkdir rulebreaker-selinux-1.0.0
cd rulebreaker-selinux-1.0.0

[ ! -f "rulebreaker.sh" ] && sepolicy generate --init /usr/bin/rulebreaker

tree
#.
# ├── rulebreaker.fc
# ├── rulebreaker.if
# ├── rulebreaker_selinux.spec
# ├── rulebreaker.sh
# └── rulebreaker.te

sudo ./rulebreaker.sh --update
sudo dnf install --reinstall rulebreaker_selinux-1.0-1.fc40app.src.rpm
```
